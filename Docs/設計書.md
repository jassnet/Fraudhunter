# クリックログ・成果ログ集計・不正検知基盤 設計書（IP/UA重複調査）

## 1. 概要

### 1.1 背景

* 自社ASPでは ACS をトラッキング基盤として利用している。
* フラウド（不正トラフィック・不正成果）検知の一環として、
  「クリックログの IP / UserAgent（UA）重複パターン」から異常なトラフィックを検知したいニーズがある。
* しかし、clickログは 1 日あたり数十万件規模となるため、
  全件を都度生ログとして処理するアプローチは運用負荷や性能面のリスクがある。
* **ポストバック経由の成果**では、`ipaddress` / `useragent` がポストバックサーバーのものになるが、
  成果ログには `entry_ipaddress` / `entry_useragent`（実ユーザーのIP/UA）が含まれているため、
  これを使用することで正確なフラウド検知が可能。

### 1.2 目的

本設計書の目的は、以下の要件を満たすシステムの設計を明確にすること。

* ACS の clickログを定期取得し、自社DBに安全かつ効率的に蓄積する。
* IP × UA × 媒体 × 案件 × 日付ごとに集計した「クリック集計テーブル」を構築する。
* 集計テーブルを用いて、IP/UA 重複が多い組み合わせを抽出し、フラウド候補として運用部門に提示する。
* **成果ログの `entry_ipaddress` / `entry_useragent`（実ユーザーのIP/UA）を使用して、成果ベースのフラウド検知を行う。**
* 将来的な拡張（スコアリングロジックとの統合）を見据えた柔軟なデータモデルとする。

---

## 2. 対象範囲

本設計の対象は以下とする。

* ACS clickログ取得バッチ処理
* ACS 成果ログ（action_log_raw）取得バッチ処理
* クリックログの格納・集計テーブル設計
* 成果ログの格納・集計テーブル設計
* **成果ログの `entry_ipaddress` / `entry_useragent` を使用したフラウド検知**
* IP/UA重複検出ロジック（集計SQL・判定条件）
* 結果を参照するためのデータ提供（管理画面やBIツールから参照可能な状態）

対象外とするもの（別途設計）。

* 媒体・案件への自動アラート/自動制御
* UI詳細設計（画面レイアウト・コンポーネント仕様）
* スコアリングによる自動判定

---

## 3. 用語定義

* ACS：外部トラッキングシステム（本設計では一般的にACSと表現）
* clickログ：ACS が提供するクリック単位のログ（API: `/track_log/search` を想定）
* 成果ログ：ACS が提供する成果単位のログ（API: `/action_log_raw/search`）
* cid：クリックID。成果ログの `check_log_raw` フィールドで参照される（将来の拡張用）
* IP：`ipaddress` フィールド
* UA：`useragent` フィールド
* entry_ipaddress：成果ログに含まれる**実ユーザーのIP**（フラウド検知に使用）
* entry_useragent：成果ログに含まれる**実ユーザーのUA**（フラウド検知に使用）
* 媒体：`media_id`
* 案件：`program_id`（名称はACS仕様に合わせて変更）
* ポストバック：広告主サーバーから成果通知を受け取る仕組み

---

## 4. 要件

### 4.1 機能要件

#### クリックログ関連

1. **クリックログ取得**

   * ACSのclickログAPIから指定期間（原則前日分）のクリックログを取得する。
   * ページングに対応し、1日分の全データを漏れなく取得する。
   * 取得範囲は日次バッチで「前日 00:00:00〜23:59:59」を基本とする。

2. **生ログ保存（オプション）**

   * 取得したクリックログを `click_raw` テーブルに保存する。
   * 将来のクリックベース拡張（cidによる突合など）のために保存を推奨。
   * ストレージ制約により不要な場合は、集計処理のみ行い、生ログは保持しない構成も許容。

3. **IP/UA × 媒体 × 案件 × 日次の集計**

   * クリックログを以下キーで集計する。
     * 日付（date）
     * 媒体ID（media_id）
     * 案件ID（program_id）
     * IPアドレス（ipaddress）
     * ユーザーエージェント（useragent）
   * 集計値として、以下を保持する。
     * `click_count`：当該キーでのクリック件数
     * `first_time`：当該キーで最初のクリック時刻
     * `last_time`：当該キーで最後のクリック時刻

#### 成果ログ関連

4. **成果ログ取得**

   * ACSの成果ログAPI（`action_log_raw/search`）から指定期間の成果を取得する。
   * ページングに対応し、1日分の全データを漏れなく取得する。

5. **実ユーザーIP/UAの取得**

   * 成果ログには以下の2種類のIP/UAが含まれる：
     * `ipaddress` / `useragent`：ポストバックサーバーのIP/UA（参考情報）
     * `entry_ipaddress` / `entry_useragent`：**実ユーザーのIP/UA**
   * フラウド検知には `entry_ipaddress` / `entry_useragent` を使用する。
   * **クリックログとの突合は不要**（成果ログに直接実ユーザー情報が含まれているため）。

6. **成果のIP/UA集計**

   * `entry_ipaddress` / `entry_useragent` をキーとして成果を集計
   * これにより、ポストバック経由でも実ユーザーのIP/UAで検知可能

#### フラウド検知

7. **クリックベースのフラウド候補IP/UA抽出**

   * 日付単位で、条件を満たす「疑わしいIP/UA」を抽出する。
   * 条件の例：
     * 1IP/UAあたりのクリック数が異常に多い（例：50件以上）
     * 同一IP/UAが複数媒体・複数案件に跨って出現している など

8. **成果ベースのフラウド候補IP/UA抽出**

   * `entry_ipaddress` / `entry_useragent`（実ユーザーIP/UA）をベースに、疑わしい成果パターンを検出
   * 条件の例：
     * 同一IP/UAからの成果数が異常に多い（例：5件以上）
     * 短時間での成果集中（例：30分以内に3件以上）
     * 複数媒体・複数案件への成果発生

9. **統合検知（高リスク判定）**

   * クリックと成果の両方で疑わしいと判定されたIP/UAを高リスクとして特定

10. **リラン対応**

    * 任意の日付について再取得・再集計が可能であること。
    * データ不備や閾値変更に対し、翌日以降の再集計が容易であること。

### 4.2 非機能要件

* **性能**

  * 1日あたりクリック数：最大 1,000,000 件程度まで対応可能とする。
  * 1日あたり成果数：最大 100,000 件程度まで対応可能とする。
  * バッチ処理時間：1日分のデータ処理が1時間以内に完了することを目標とする。
* **拡張性**

  * 将来的にスコアリング等とのJOINを行う想定で、キー設計と正規化を意識する。
* **可用性**

  * API障害やネットワークエラーに備え、リトライや手動リランで復旧可能とする。

---

## 5. 全体アーキテクチャ

### 5.1 構成要素

1. **ACS**

   * `/track_log/search` APIを提供（クリックログ、IP/UA含む）
   * `/action_log_raw/search` APIを提供（成果ログ、entry_ipaddress/entry_useragent含む）

2. **バッチサーバ**

   * ACS API呼び出しロジックを実装する。
   * 日次ジョブスケジューラ（cron等）で定期実行。

3. **アプリケーションDB**

   * `click_raw` テーブル（クリック生ログ、オプション）
   * `click_ipua_daily` テーブル（クリック集計）
   * `conversion_raw` テーブル（成果生ログ、entry IP/UA含む）
   * `conversion_ipua_daily` テーブル（成果集計、実ユーザーIP/UAベース）

4. **管理画面 / BIツール**

   * 各テーブルを参照し、疑わしいIP/UAを確認する。

### 5.2 データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        日次バッチ処理                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. クリックログ取得                                            │
│     ACS /track_log/search → click_raw + click_ipua_daily        │
│                                                                 │
│  2. 成果ログ取得                                                │
│     ACS /action_log_raw/search                                  │
│              ↓                                                  │
│     entry_ipaddress / entry_useragent を抽出                    │
│     （実ユーザーのIP/UA）                                       │
│              ↓                                                  │
│  3. conversion_raw + conversion_ipua_daily に保存               │
│              ↓                                                  │
│  4. フラウド検知                                                │
│     - クリックベース検知                                        │
│     - 成果ベース検知（実ユーザーIP/UA）                         │
│     - 両方で検出 → 高リスク                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. テーブル設計

### 6.1 click_raw テーブル（オプション）

クリックログの生データ。将来のクリックベース拡張用に保存を推奨。

```text
テーブル名: click_raw

カラム:
- id             TEXT PRIMARY KEY    クリックID（track_cidを使用）
- click_time     TEXT NOT NULL       クリック日時
- media_id       TEXT                媒体ID
- program_id     TEXT                案件ID
- ipaddress      TEXT                IPアドレス
- useragent      TEXT                ユーザーエージェント
- referrer       TEXT                リファラURL
- raw_payload    TEXT                ACSから取得した元レスポンス（JSON）
- created_at     TEXT NOT NULL       レコード作成日時
- updated_at     TEXT NOT NULL       レコード更新日時

インデックス:
- idx_click_raw_time      (click_time)
- idx_click_raw_media     (media_id, click_time)
- idx_click_raw_program   (program_id, click_time)
```

### 6.2 click_ipua_daily テーブル（クリック集計）

IP/UA単位のクリック集計テーブル。

```text
テーブル名: click_ipua_daily

カラム:
- date          TEXT NOT NULL       日付 (集計単位)
- media_id      TEXT NOT NULL       媒体ID
- program_id    TEXT NOT NULL       案件ID
- ipaddress     TEXT NOT NULL       IPアドレス
- useragent     TEXT NOT NULL       ユーザーエージェント
- click_count   INTEGER NOT NULL    当日クリック数
- first_time    TEXT NOT NULL       当日最初のクリック時刻
- last_time     TEXT NOT NULL       当日最後のクリック時刻
- created_at    TEXT NOT NULL       レコード作成日時
- updated_at    TEXT NOT NULL       レコード更新日時

主キー:
- PRIMARY KEY (date, media_id, program_id, ipaddress, useragent)

インデックス:
- idx_click_ipua_daily_date              (date)
- idx_click_ipua_daily_date_ip           (date, ipaddress)
```

### 6.3 conversion_raw テーブル（成果生ログ）

成果ログの生データ。実ユーザーのIP/UAを保持。

```text
テーブル名: conversion_raw

カラム:
- id                  TEXT PRIMARY KEY    成果ID
- cid                 TEXT                クリックID（将来の拡張用）
- conversion_time     TEXT NOT NULL       成果発生日時
- click_time          TEXT                クリック日時
- media_id            TEXT                媒体ID
- program_id          TEXT                案件ID
- user_id             TEXT                アフィリエイターID
- postback_ipaddress  TEXT                ポストバック時のIP（参考用）
- postback_useragent  TEXT                ポストバック時のUA（参考用）
- entry_ipaddress     TEXT                実ユーザーのIP（フラウド検知に使用）
- entry_useragent     TEXT                実ユーザーのUA（フラウド検知に使用）
- state               TEXT                ステータス
- raw_payload         TEXT                元レスポンス（JSON）
- created_at          TEXT NOT NULL       レコード作成日時
- updated_at          TEXT NOT NULL       レコード更新日時

インデックス:
- idx_conversion_raw_time      (conversion_time)
- idx_conversion_raw_cid       (cid)
- idx_conversion_raw_media     (media_id, conversion_time)
- idx_conversion_raw_program   (program_id, conversion_time)
```

### 6.4 conversion_ipua_daily テーブル（成果集計）

実ユーザーのIP/UAをキーとした成果集計テーブル。

```text
テーブル名: conversion_ipua_daily

カラム:
- date              TEXT NOT NULL       日付
- media_id          TEXT NOT NULL       媒体ID
- program_id        TEXT NOT NULL       案件ID
- ipaddress         TEXT NOT NULL       実ユーザーのIPアドレス（entry_ipaddress）
- useragent         TEXT NOT NULL       実ユーザーのユーザーエージェント（entry_useragent）
- conversion_count  INTEGER NOT NULL    成果件数
- first_time        TEXT NOT NULL       最初の成果時刻
- last_time         TEXT NOT NULL       最後の成果時刻
- created_at        TEXT NOT NULL       レコード作成日時
- updated_at        TEXT NOT NULL       レコード更新日時

主キー:
- PRIMARY KEY (date, media_id, program_id, ipaddress, useragent)

インデックス:
- idx_conversion_ipua_daily_date     (date)
- idx_conversion_ipua_daily_date_ip  (date, ipaddress)
```

---

## 7. バッチ処理設計

### 7.1 ジョブ構成

1. `JOB_CLICK_LOG_IMPORT`

   * ACSからclickログを取得し、`click_raw` と `click_ipua_daily` を更新するジョブ。

2. `JOB_CONVERSION_LOG_IMPORT`

   * ACSから成果ログを取得
   * `entry_ipaddress` / `entry_useragent` を抽出して保存
   * `conversion_raw` と `conversion_ipua_daily` を更新

3. `JOB_FRAUD_DETECTION`

   * クリックベースの検知
   * 成果ベースの検知
   * 高リスクIP/UAの特定

### 7.2 実行スケジュール

* 毎日 03:00 に、前日（00:00〜23:59）のデータについて実行。
* 実行順序：
  1. クリックログ取り込み
  2. 成果ログ取り込み
  3. フラウド検知レポート出力
* 手動リラン用に任意の日付をパラメータ指定して実行できるようにする。

### 7.3 ACS API呼び出し仕様

#### クリックログ
* エンドポイント：`GET /track_log/search`
* 認証：`X-Auth-Token: {accessKey}:{secretKey}`
* パラメータ：
  * `limit`: 取得件数（max 500）
  * `offset`: オフセット（0始まり）
  * `regist_unix=between_date`: 日付検索方式
  * `regist_unix_A_Y/M/D`, `regist_unix_B_Y/M/D`: 検索範囲

#### 成果ログ
* エンドポイント：`GET /action_log_raw/search`
* 認証：同上
* パラメータ：同上
* 重要フィールド：
  * `id`: 成果ID
  * `check_log_raw`: cid（クリックIDへの参照、将来の拡張用）
  * `entry_ipaddress`: **実ユーザーのIP**（フラウド検知に使用）
  * `entry_useragent`: **実ユーザーのUA**（フラウド検知に使用）
  * `ipaddress` / `useragent`: ポストバックサーバーのIP/UA（参考情報）
  * `regist_unix`: 成果発生日時

### 7.4 成果ログ処理ロジック

```python
# 成果ログを取得
conversions = fetch_conversion_logs(target_date)

# entry_ipaddress / entry_useragent が有効なものをカウント
valid_count = sum(1 for c in conversions 
                  if c.entry_ipaddress and c.entry_useragent)

# 保存（entry IP/UAが有効なものは集計にも追加される）
for conv in conversions:
    # 生ログを保存
    insert_conversion_raw(conv)
    
    # entry IP/UAが有効な場合のみ集計テーブルに追加
    if conv.entry_ipaddress and conv.entry_useragent:
        upsert_conversion_aggregate(conv)
```

### 7.5 エラーハンドリング・リトライ

* ACS API呼び出しが失敗した場合：
  * HTTPステータスが5xx：指数バックオフ付きでリトライ（例：最大3回）。
  * 4xxエラー：ログを出力し、そのページ分はスキップして運用アラートを上げる。
* entry_ipaddress / entry_useragent がない場合：
  * 成果は保存するが、集計テーブルには追加されない（検知対象外）
* DBエラー：
  * トランザクション単位でロールバックし、バッチ全体をエラー終了。
  * 対象日のリランで再実行可能とする。

---

## 8. IP/UA重複調査ロジック

### 8.1 クリックベースの抽出SQL例

```sql
SELECT
  date,
  ipaddress,
  useragent,
  SUM(click_count) AS total_clicks,
  COUNT(DISTINCT media_id)   AS media_count,
  COUNT(DISTINCT program_id) AS program_count,
  MIN(first_time) AS first_time,
  MAX(last_time)  AS last_time
FROM click_ipua_daily
WHERE date = :target_date
GROUP BY date, ipaddress, useragent
HAVING
  SUM(click_count) >= :click_threshold      -- 例: 50
  OR COUNT(DISTINCT media_id) >= :media_threshold    -- 例: 3
  OR COUNT(DISTINCT program_id) >= :program_threshold -- 例: 3
ORDER BY total_clicks DESC;
```

### 8.2 成果ベースの抽出SQL例

```sql
SELECT
  date,
  ipaddress,
  useragent,
  SUM(conversion_count) AS total_conversions,
  COUNT(DISTINCT media_id)   AS media_count,
  COUNT(DISTINCT program_id) AS program_count,
  MIN(first_time) AS first_time,
  MAX(last_time)  AS last_time
FROM conversion_ipua_daily
WHERE date = :target_date
GROUP BY date, ipaddress, useragent
HAVING
  SUM(conversion_count) >= :conversion_threshold  -- 例: 5
  OR COUNT(DISTINCT media_id) >= :media_threshold -- 例: 2
  OR COUNT(DISTINCT program_id) >= :program_threshold -- 例: 2
ORDER BY total_conversions DESC;
```

### 8.3 判定ルール

#### クリックベース（初期案）
1. **トータルクリック数** `SUM(click_count) >= 50`
2. **複数媒体** `media_count >= 3`
3. **複数案件** `program_count >= 3`
4. **バースト** `last_time - first_time <= 10分` かつ `total_clicks >= 20`

#### 成果ベース（初期案）
1. **トータル成果数** `SUM(conversion_count) >= 5`
2. **複数媒体** `media_count >= 2`
3. **複数案件** `program_count >= 2`
4. **バースト** `last_time - first_time <= 30分` かつ `total_conversions >= 3`

#### 高リスク判定
* クリックベースと成果ベースの**両方**で疑わしいと判定されたIP/UA
* これらは優先的に調査対象とする

---

## 9. CLI コマンド一覧

| コマンド | 説明 |
|---------|------|
| `ingest` | クリックログを取り込む |
| `suspicious` | クリックベースの不正検知 |
| `daily` | クリックのデイリーバッチ |
| `ingest-conversions` | 成果ログを取り込む（entry IP/UAを使用） |
| `suspicious-conversions` | 成果ベースの不正検知 |
| `daily-full` | クリック＋成果の統合デイリーバッチ |
| `refresh` | 最新データのオンデマンド取り込み（重複チェック付き） |

### 9.1 refreshコマンド（オンデマンド取り込み）

日次バッチに加えて、任意のタイミングで最新データを取り込むためのコマンド。

```bash
python -m fraud_checker.cli refresh --hours 24 --detect
```

**特徴:**
- 現在時刻から指定時間（デフォルト24時間）前のデータを取得
- **日次バッチとの重複を自動回避**: IDベースで既存データをチェック
- 新規データのみ追加し、既存データはスキップ
- オプションで検知処理も実行可能

**オプション:**
| オプション | 説明 |
|-----------|------|
| `--hours N` | 取得する時間範囲（デフォルト: 24） |
| `--clicks-only` | クリックログのみ取り込み |
| `--conversions-only` | 成果ログのみ取り込み |
| `--detect` | 取り込み後にフラウド検知も実行 |

**ユースケース:**
- リアルタイムに近い監視が必要な場合
- 日次バッチの間に急ぎで確認したい場合
- 特定の時間帯のデータを追加で取り込みたい場合

---

## 10. 環境変数一覧

| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| `ACS_BASE_URL` | 必須 | ACS APIのベースURL |
| `ACS_ACCESS_KEY` | 必須 | アクセスキー |
| `ACS_SECRET_KEY` | 必須 | シークレットキー |
| `ACS_TOKEN` | - | `access_key:secret_key`形式 |
| `ACS_LOG_ENDPOINT` | `track_log/search` | クリックログAPIエンドポイント |
| `FRAUD_DB_PATH` | 必須 | SQLiteデータベースパス |
| `FRAUD_PAGE_SIZE` | 500 | APIページサイズ |
| `FRAUD_STORE_RAW` | false | クリック生ログ保存（将来の拡張用） |
| `FRAUD_CLICK_THRESHOLD` | 50 | クリック数閾値 |
| `FRAUD_MEDIA_THRESHOLD` | 3 | 媒体数閾値（クリック） |
| `FRAUD_PROGRAM_THRESHOLD` | 3 | 案件数閾値（クリック） |
| `FRAUD_BURST_CLICK_THRESHOLD` | 20 | バーストクリック数 |
| `FRAUD_BURST_WINDOW_SECONDS` | 600 | バースト時間窓（秒） |
| `FRAUD_CONVERSION_THRESHOLD` | 5 | 成果数閾値 |
| `FRAUD_CONV_MEDIA_THRESHOLD` | 2 | 媒体数閾値（成果） |
| `FRAUD_CONV_PROGRAM_THRESHOLD` | 2 | 案件数閾値（成果） |
| `FRAUD_BURST_CONVERSION_THRESHOLD` | 3 | バースト成果数 |
| `FRAUD_BURST_CONVERSION_WINDOW_SECONDS` | 1800 | バースト時間窓（秒） |
| `FRAUD_BROWSER_ONLY` | false | ブラウザUA限定 |
| `FRAUD_EXCLUDE_DATACENTER_IP` | false | データセンターIP除外 |

---

## 11. 成果ログのIP/UA構造

成果ログには以下の2種類のIP/UAが含まれます：

| フィールド | 説明 | 用途 |
|-----------|------|------|
| `ipaddress` / `useragent` | ポストバックサーバーのIP/UA | 参考情報として保存 |
| `entry_ipaddress` / `entry_useragent` | **実ユーザーのIP/UA** | **フラウド検知に使用** |

### なぜ2種類あるのか

```
【成果発生フロー】

1. ユーザーがクリック
   ユーザーのブラウザ → 広告クリック
   IP: 203.168.114.96 (ユーザーのIP)
   UA: Mozilla/5.0 (iPhone...)

2. 成果発生（ポストバック）
   広告主サーバー → ACSにポストバック通知
   IP: 49.212.160.90 (ポストバックサーバーのIP)
   UA: leafworks/1.0 (システムのUA)

3. ACSが記録
   - ipaddress: 49.212.160.90 (ポストバックサーバー)
   - useragent: leafworks/1.0 (ポストバックサーバー)
   - entry_ipaddress: 203.168.114.96 (実ユーザー) ← これを使用
   - entry_useragent: Mozilla/5.0 (iPhone...) (実ユーザー) ← これを使用
```

### フラウド検知での使用

本システムでは `entry_ipaddress` / `entry_useragent` を使用してフラウド検知を行います。
これにより、ポストバック経由の成果でも、実ユーザーのIP/UAで不正パターンを検出できます。
